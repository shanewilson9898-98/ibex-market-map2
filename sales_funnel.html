<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shane Wilson for Ibex: Winter 2026 Deal Flow</title>
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #fff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #7c3aed;
      --brand-2: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      background: radial-gradient(1200px 500px at top, #f1efff 0%, var(--bg) 42%, #f8fafc 100%);
      padding: 24px 14px 34px;
      color: var(--ink);
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--line);
    }

    .header h1 {
      font-size: clamp(1.7rem, 4.2vw, 2.8rem);
      font-weight: 800;
      color: #5b35ba;
      margin-bottom: 8px;
      line-height: 1.15;
      letter-spacing: -0.02em;
    }

    .header .subtitle { font-size: clamp(.95rem, 2vw, 1.1rem); color: var(--muted); }

    .nav-links {
      margin-bottom: 18px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-links a {
      display: inline-block;
      padding: 9px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: .9rem;
      text-decoration: none;
      color: #5d2cc5;
      border: 1px solid #ddd6fe;
      background: #ede9fe;
      transition: all .2s ease;
    }
    .nav-links a:hover, .nav-links a.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .status {
      max-width: 980px;
      margin: 0 auto 16px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: #374151;
      font-size: 14px;
      line-height: 1.35;
    }
    .status strong { color: #111827; }
    .status.error { border-color: #fecaca; background: #fff1f2; color: #991b1b; }
    .status.ok { border-color: #bbf7d0; background: #ecfdf5; color: #065f46; }
    .status .muted { color: #6b7280; }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin: 14px auto 18px;
      max-width: 820px;
    }

    .metric {
      text-align: center;
      padding: 18px 12px;
      border-radius: 14px;
      background: #fff;
      border: 1px solid #e9d5ff;
      box-shadow: 0 6px 20px rgba(124,58,237,.08);
    }

    .metric-value { font-size: clamp(1.5rem, 4vw, 2.3rem); font-weight: 800; color: var(--brand); margin-bottom: 4px; }
    .metric-label { font-size: .75rem; color: #6b7280; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; }

    .funnel-wrapper { max-width: 860px; margin: 10px auto 22px; }

    .funnel-stage {
      position: relative;
      margin: 0 auto;
      min-height: 96px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stage-1, .stage-2, .stage-3 {
      height: 106px;
      margin: 0 auto;
      box-shadow: 0 6px 24px rgba(124,58,237,.16);
    }

    .stage-1 {
      width: min(100%, 760px);
      background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
      clip-path: polygon(6% 0%, 94% 0%, 88% 100%, 12% 100%);
    }
    .stage-2 {
      width: min(92%, 620px);
      background: linear-gradient(135deg, #8b5cf6 0%, #c4b5fd 100%);
      clip-path: polygon(8% 0%, 92% 0%, 84% 100%, 16% 100%);
      margin-top: -8px;
    }
    .stage-3 {
      width: min(84%, 470px);
      background: linear-gradient(135deg, #9333ea 0%, #d8b4fe 100%);
      clip-path: polygon(12% 0%, 88% 0%, 78% 100%, 22% 100%);
      margin-top: -8px;
    }

    .stage-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      text-align: center;
      width: 100%;
      pointer-events: none;
    }

    .stage-label { font-size: clamp(.95rem, 2.8vw, 1.4rem); font-weight: 700; margin-bottom: 6px; }
    .stage-count { font-size: clamp(1.5rem, 5vw, 2.6rem); font-weight: 800; }

    .divider {
      margin: 24px auto 10px;
      max-width: 1200px;
      border-top: 2px dashed #c4b5fd;
      position: relative;
      height: 0;
    }

    .divider span {
      position: absolute;
      left: 50%;
      top: 0;
      transform: translate(-50%, -50%);
      background: var(--bg);
      padding: 0 10px;
      font-size: .72rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .07em;
      font-weight: 700;
    }

    .split-section {
      margin-top: 18px;
      padding: 0 2px;
    }

    .split-title {
      font-size: clamp(.95rem, 2.2vw, 1.1rem);
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .split-title .count {
      font-size: .74rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 700;
    }

    .diligence-companies {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 8px;
    }

    .diligence-card {
      position: relative;
      overflow: visible;
      background: #fff;
      border: 1px solid #e9d5ff;
      border-radius: 12px;
      padding: 14px 10px;
      min-height: 130px;
      text-align: center;
      transition: all .2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .diligence-card:hover { border-color: #a78bfa; box-shadow: 0 8px 20px rgba(124,58,237,.12); }

    .logo-shell {
      width: 84px;
      height: 62px;
      margin-bottom: 9px;
      padding: 8px;
      border: 1px solid #eef0f4;
      border-radius: 10px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .diligence-logo { width: 100%; height: 100%; object-fit: contain; filter: contrast(1.08) saturate(1.05); }
    .diligence-placeholder {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(135deg, #ede9fe 0%, #faf5ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #7c3aed;
      font-size: 11px;
      font-weight: 700;
      line-height: 1.2;
      padding: 6px;
    }

    .diligence-name { font-size: 12.5px; color: #374151; font-weight: 700; line-height: 1.25; }

    .tag {
      margin-top: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .05em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #ddd6fe;
      color: #5d2cc5;
      background: #f5f3ff;
    }

    .tooltip {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 10px);
      transform: translateX(-50%);
      width: min(90vw, 340px);
      background: rgba(17,24,39,.96);
      color: #fff;
      padding: 12px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.35;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 30;
      text-align: left;
    }
    .diligence-card:hover .tooltip { opacity: 1; transform: translateX(-50%) translateY(-2px); }
    .tooltip h4 { font-size: 13px; margin-bottom: 6px; font-weight: 800; }
    .tooltip .section-title {
      margin-top: 8px; margin-bottom: 4px;
      font-size: 10px; text-transform: uppercase; letter-spacing: .06em; opacity: .85; font-weight: 700;
    }
    .tooltip .content { max-height: 170px; overflow: auto; }

    .footer {
      text-align: center;
      margin-top: 28px;
      padding-top: 22px;
      border-top: 1px solid var(--line);
    }
    .footer-branding { font-size: 13px; color: #9ca3af; }

    @media (max-width: 1200px) { .diligence-companies { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (max-width: 900px) {
      .diligence-companies { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .metrics-row { grid-template-columns: 1fr; }
    }
    @media (max-width: 560px) {
      body { padding: 14px 10px 24px; }
      .diligence-companies { grid-template-columns: 1fr; gap: 10px; }
      .stage-1, .stage-2, .stage-3 { height: 92px; }
    }
    @media (hover: none) { .tooltip { display: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="page-title">Shane Wilson for Ibex: Winter 2026 Deal Flow</h1>
      <div class="subtitle" id="page-subtitle">Evaluation Pipeline &amp; Company Progression</div>
    </div>

    <div class="nav-links">
      <a href="index.html">Market Map</a>
      <a class="active" href="sales_funnel.html">Deal Flow</a>
    </div>

    <div id="status" class="status">
      <strong>Loading data</strong>
      <div class="muted">If this hangs, the endpoint URL is wrong or blocked.</div>
    </div>

    <!-- moved ABOVE funnel -->
    <div class="metrics-row">
      <div class="metric">
        <div class="metric-value" id="metric-connection-rate">0.0%</div>
        <div class="metric-label">Connection Rate</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="metric-call-executed-rate">0.0%</div>
        <div class="metric-label">Call Executed Rate</div>
      </div>
    </div>

    <div class="funnel-wrapper">
      <div class="funnel-stage">
        <div class="stage-1"></div>
        <div class="stage-content"><div class="stage-label">Contacted</div><div class="stage-count" id="count-contacted">0</div></div>
      </div>
      <div class="funnel-stage">
        <div class="stage-2"></div>
        <div class="stage-content"><div class="stage-label">Connected</div><div class="stage-count" id="count-connected">0</div></div>
      </div>
      <div class="funnel-stage">
        <div class="stage-3"></div>
        <div class="stage-content"><div class="stage-label">Call Executed</div><div class="stage-count" id="count-call-executed">0</div></div>
      </div>
    </div>

    <!-- Above the line: passed -->
    <div class="split-section">
      <div class="split-title">
        <span>Above the Line: Passed</span>
        <span class="count" id="passed-count">0 companies</span>
      </div>
      <div class="diligence-companies" id="passed-grid"></div>
    </div>

    <div class="divider"><span>Decision Line</span></div>

    <!-- Below the line: not passed -->
    <div class="split-section">
      <div class="split-title">
        <span>Below the Line: Not Passed</span>
        <span class="count" id="not-passed-count">0 companies</span>
      </div>
      <div class="diligence-companies" id="not-passed-grid"></div>
    </div>

    <div class="footer">
      <div class="footer-branding" id="footer-text">© 2026 IBEX Investors, Inc. | Winter 2026</div>
    </div>
  </div>

  <script>
    const CONFIG = {
      endpointBase: "https://script.google.com/macros/s/AKfycbyRF62OEmU2SFH3juvFeCmklF4nKLhFr-6VEGNFHES4ZCi5D0-1dOx7LK4fSs_fiDJN/exec",
      view: "marketmap",
      pageTitle: "Shane Wilson for Ibex: Winter 2026 Deal Flow",
      pageSubtitle: "Evaluation Pipeline & Company Progression",
      footerText: "© 2026 IBEX Investors, Inc. | Winter 2026",
      maxCards: null
    };

    function $(id) { return document.getElementById(id); }
    function escapeHtml(str) {
      return String(str ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }
    function setStatus(type, title, details) {
      const el = $("status");
      el.className = "status " + (type || "");
      el.innerHTML = `<strong>${escapeHtml(title)}</strong>${details ? `<div class="muted">${escapeHtml(details)}</div>` : ""}`;
    }
    function pct(n, d) { return d ? ((n / d) * 100).toFixed(1) + "%" : "0.0%"; }
    function safeOpen(url) {
      if (!url) return;
      try { window.open(new URL(url, window.location.href).href, "_blank", "noopener,noreferrer"); } catch {}
    }
    function loadJsonp(url, callbackName) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url; script.async = true;
        const timeout = setTimeout(() => { cleanup(); reject(new Error("JSONP request timed out")); }, 15000);
        function cleanup() { clearTimeout(timeout); script.remove(); try { delete window[callbackName]; } catch { window[callbackName] = undefined; } }
        window[callbackName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("Failed to load JSONP script")); };
        document.head.appendChild(script);
      });
    }
    function deriveDomain(rawUrl) {
      try { return new URL(rawUrl).hostname.replace(/^www\./i, ""); } catch { return ""; }
    }
    function createLogoFallback(img, logoUrl, companyUrl) {
      const candidates = [];
      if (logoUrl) candidates.push(logoUrl);
      const domain = deriveDomain(companyUrl);
      if (domain) candidates.push("https://logo.clearbit.com/" + domain);
      let i = 0;
      return () => (i < candidates.length ? (img.src = candidates[i++], true) : false);
    }

    // tolerant parser for your new 1/0 pass column from Market Map Payload
    function getPassedFlag(row) {
      const preferredKeys = ["Passed", "Passed On", "Passed?", "Pass", "Passed (1/0)", "Pass (1/0)", "passed", "passed_on"];
      let raw;
      for (const k of preferredKeys) {
        if (Object.prototype.hasOwnProperty.call(row, k)) { raw = row[k]; break; }
      }
      if (raw === undefined) {
        const passKey = Object.keys(row).find(k => /pass/i.test(k));
        if (passKey) raw = row[passKey];
      }

      if (typeof raw === "number") return raw > 0;
      const v = String(raw ?? "").trim().toLowerCase();
      if (["1", "true", "yes", "y", "passed"].includes(v)) return true;
      if (["0", "false", "no", "n", ""].includes(v)) return false;
      return false;
    }

    function buildDisplayName(c) {
      const name = String(c["Company Name"] || "").trim() || "Unknown";
      const cat = String(c["Category"] || "").trim();
      return cat ? `${name} (${cat})` : name;
    }

    function makeCard(c, passed) {
      const displayName = buildDisplayName(c);
      const website = String(c["Url"] || "").trim();
      const logo = String(c["Logo link"] || "").trim();
      const callNotes = String(c["Call Notes"] || "").trim();
      const decision = String(c["Decision And Reason"] || "").trim();

      const card = document.createElement("div");
      card.className = "diligence-card";
      card.tabIndex = 0;
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", displayName);
      card.addEventListener("click", () => safeOpen(website));
      card.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); safeOpen(website); } });

      const shell = document.createElement("div");
      shell.className = "logo-shell";

      const img = document.createElement("img");
      img.className = "diligence-logo";
      img.alt = displayName;
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.style.display = "none";

      const placeholder = document.createElement("div");
      placeholder.className = "diligence-placeholder";
      placeholder.style.display = "flex";
      placeholder.textContent = displayName;

      const tryNextLogo = createLogoFallback(img, logo, website);
      img.onload = () => {
        if (img.naturalWidth > 0) {
          img.style.display = "block";
          placeholder.style.display = "none";
        } else if (!tryNextLogo()) {
          img.style.display = "none";
          placeholder.style.display = "flex";
        }
      };
      img.onerror = () => {
        if (!tryNextLogo()) {
          img.style.display = "none";
          placeholder.style.display = "flex";
        }
      };
      if (!tryNextLogo()) placeholder.style.display = "flex";

      const nameEl = document.createElement("div");
      nameEl.className = "diligence-name";
      nameEl.textContent = displayName;

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = passed ? "Passed" : "Not Passed";

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
      tooltip.innerHTML = `
        <h4>${escapeHtml(displayName)}</h4>
        <div class="section-title">Call Notes</div>
        <div class="content">${escapeHtml(callNotes || "No call notes").replaceAll("\n","<br>")}</div>
        <div class="section-title">Decision + Reason</div>
        <div class="content">${escapeHtml(decision || "No decision notes").replaceAll("\n","<br>")}</div>
      `;

      shell.appendChild(img);
      shell.appendChild(placeholder);
      card.appendChild(shell);
      card.appendChild(nameEl);
      card.appendChild(tag);
      card.appendChild(tooltip);
      return card;
    }

    function renderEmpty(gridEl, message) {
      const empty = document.createElement("div");
      empty.className = "status";
      empty.style.gridColumn = "1 / -1";
      empty.innerHTML = `<strong>${escapeHtml(message)}</strong>`;
      gridEl.appendChild(empty);
    }

    async function loadAndRender() {
      $("page-title").textContent = CONFIG.pageTitle;
      $("page-subtitle").innerHTML = CONFIG.pageSubtitle;
      $("footer-text").textContent = CONFIG.footerText;
      setStatus("", "Loading data", "Fetching from Apps Script (JSONP)");

      const cbName = "handleMarketMapPayload_" + Math.random().toString(16).slice(2);
      const url = `${CONFIG.endpointBase}?view=${encodeURIComponent(CONFIG.view)}&callback=${encodeURIComponent(cbName)}&t=${Date.now()}`;

      let payload;
      try { payload = await loadJsonp(url, cbName); }
      catch (err) { setStatus("error", "Failed to load data", String(err)); return; }

      if (!payload || payload.ok !== true) {
        setStatus("error", "Endpoint returned an error", payload?.error || "Unknown error");
        return;
      }

      const contacted = Number(payload?.funnel?.contacted ?? 0);
      const connected = Number(payload?.funnel?.connected ?? 0);
      const callExecuted = Number(payload?.funnel?.callExecuted ?? 0);

      $("count-contacted").textContent = String(contacted);
      $("count-connected").textContent = String(connected);
      $("count-call-executed").textContent = String(callExecuted);

      $("metric-connection-rate").textContent = pct(connected, contacted);
      $("metric-call-executed-rate").textContent = pct(callExecuted, contacted);

      let cards = Array.isArray(payload.callExecutedCompanies) ? payload.callExecutedCompanies : [];
      if (typeof CONFIG.maxCards === "number") cards = cards.slice(0, CONFIG.maxCards);

      const passed = cards.filter(getPassedFlag);
      const notPassed = cards.filter(c => !getPassedFlag(c));

      const passedGrid = $("passed-grid");
      const notPassedGrid = $("not-passed-grid");
      passedGrid.innerHTML = "";
      notPassedGrid.innerHTML = "";

      $("passed-count").textContent = `${passed.length} companies`;
      $("not-passed-count").textContent = `${notPassed.length} companies`;

      if (!passed.length) renderEmpty(passedGrid, "No passed companies in call executed.");
      else passed.forEach(c => passedGrid.appendChild(makeCard(c, true)));

      if (!notPassed.length) renderEmpty(notPassedGrid, "No not-passed companies in call executed.");
      else notPassed.forEach(c => notPassedGrid.appendChild(makeCard(c, false)));

      setStatus("ok", "Loaded successfully", `Rows: ${payload?.meta?.rows ?? ""}. Timestamp: ${payload?.meta?.timestamp || ""}`);
    }

    loadAndRender();
  </script>
</body>
</html>
