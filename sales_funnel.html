<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shane Wilson for Ibex: Winter 2026 Deal Flow</title>
  <style>
    :root {
      --bg:#f8fafc; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --brand:#7c3aed;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,sans-serif; background:var(--bg); color:var(--ink); padding:20px 12px 28px; }
    .container { max-width:1300px; margin:0 auto; }
    .header { text-align:center; margin-bottom:18px; padding-bottom:14px; border-bottom:1px solid var(--line); }
    h1 { font-size:clamp(1.6rem,4vw,2.6rem); color:#5b35ba; margin-bottom:8px; }
    .subtitle { color:var(--muted); }
    .nav { display:flex; justify-content:center; gap:10px; margin:12px 0 16px; flex-wrap:wrap; }
    .nav a { text-decoration:none; padding:8px 13px; border-radius:999px; border:1px solid #ddd6fe; background:#ede9fe; color:#5d2cc5; font-weight:600; }
    .nav a.active { background:var(--brand); color:#fff; border-color:var(--brand); }

    .status { margin:0 auto 14px; max-width:900px; border:1px solid var(--line); background:#fff; padding:11px 13px; border-radius:10px; font-size:14px; }
    .status.error { border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    .status.ok { border-color:#bbf7d0; background:#ecfdf5; color:#065f46; }

    .metrics { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; max-width:760px; margin:10px auto 16px; }
    .metric { text-align:center; background:#fff; border:1px solid #e9d5ff; border-radius:12px; padding:14px; }
    .metric .v { font-size:clamp(1.4rem,4vw,2.2rem); color:var(--brand); font-weight:800; }
    .metric .l { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.06em; font-weight:700; }

    .funnel { max-width:800px; margin:6px auto 18px; }
    .stage { position:relative; height:95px; margin:0 auto -6px; box-shadow:0 6px 18px rgba(124,58,237,.14); }
    .s1 { width:min(100%,760px); background:linear-gradient(135deg,#7c3aed,#a78bfa); clip-path:polygon(6% 0,94% 0,88% 100%,12% 100%); }
    .s2 { width:min(92%,610px); background:linear-gradient(135deg,#8b5cf6,#c4b5fd); clip-path:polygon(8% 0,92% 0,84% 100%,16% 100%); }
    .s3 { width:min(84%,460px); background:linear-gradient(135deg,#9333ea,#d8b4fe); clip-path:polygon(12% 0,88% 0,78% 100%,22% 100%); }
    .sc { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; }
    .sc .n { font-size:clamp(1.3rem,4vw,2.4rem); font-weight:800; }

    .section { margin-top:14px; }
    .title { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px; font-weight:800; }
    .count { font-size:12px; color:var(--muted); text-transform:uppercase; }
    .grid { display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px; }
    .card { border:1px solid #e9d5ff; background:#fff; border-radius:12px; padding:12px 10px; min-height:122px; text-align:center; cursor:pointer; position:relative; }
    .logoWrap { width:84px; height:58px; margin:0 auto 8px; border:1px solid #eef0f4; border-radius:9px; padding:7px; display:flex; align-items:center; justify-content:center; }
    .logo { width:100%; height:100%; object-fit:contain; display:none; }
    .placeholder { font-size:11px; color:#7c3aed; font-weight:700; line-height:1.2; }
    .name { font-size:12.5px; font-weight:700; color:#374151; line-height:1.25; }
    .tag { margin-top:6px; font-size:10px; text-transform:uppercase; font-weight:700; color:#5d2cc5; border:1px solid #ddd6fe; background:#f5f3ff; border-radius:999px; display:inline-block; padding:2px 7px; }

 .tooltip {
  position: fixed;
  z-index: 9999;
  width: min(560px, calc(100vw - 24px));
  max-height: calc(100vh - 24px);
  overflow-y: auto;
  overscroll-behavior: contain;
  background: rgba(15, 23, 42, 0.96);
  color: #fff;
  border-radius: 12px;
  padding: 12px 14px;
  box-shadow: 0 14px 28px rgba(0,0,0,0.35);
  line-height: 1.35;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transform: translateY(6px);
  transition: opacity 140ms ease, transform 140ms ease, visibility 140ms ease;
}

.card:hover .tooltip,
.card.tooltip-open .tooltip {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

    .tooltip strong { display:block; margin-bottom:6px; }

    @media (hover: hover) {
      .card:hover .tooltip { opacity:1; pointer-events:auto; transform:translateX(var(--tip-x, -50%)) translateY(-2px); }
    }

    .card.show-tip .tooltip { opacity:1; pointer-events:auto; transform:translateX(var(--tip-x, -50%)) translateY(-2px); }

    .divider { border-top:2px dashed #c4b5fd; margin:20px 0 10px; }

    @media (max-width:1100px) { .grid { grid-template-columns:repeat(3,minmax(0,1fr)); } }
    @media (max-width:760px) {
      .metrics { grid-template-columns:1fr; }
      .grid { grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:520px) { .grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="page-title">Shane Wilson for Ibex: Winter 2026 Deal Flow</h1>
      <div class="subtitle" id="page-subtitle">Evaluation Pipeline &amp; Company Progression</div>
    </div>

    <div class="nav">
      <a href="index.html">Market Map</a>
      <a class="active" href="sales_funnel.html">Deal Flow</a>
    </div>

    <div id="status" class="status">Loading data…</div>

    <div class="metrics">
      <div class="metric"><div class="v" id="metric-connection-rate">0.0%</div><div class="l">Connection Rate</div></div>
      <div class="metric"><div class="v" id="metric-call-executed-rate">0.0%</div><div class="l">Call Executed Rate</div></div>
    </div>

    <div class="funnel">
      <div class="stage s1"><div class="sc"><div>Contacted</div><div class="n" id="count-contacted">0</div></div></div>
      <div class="stage s2"><div class="sc"><div>Connected</div><div class="n" id="count-connected">0</div></div></div>
      <div class="stage s3"><div class="sc"><div>Call Executed</div><div class="n" id="count-call-executed">0</div></div></div>
    </div>

    <div class="section">
      <div class="title"><span>Call Executed: Pass</span><span class="count" id="passed-count">0 companies</span></div>
      <div class="grid" id="passed-grid"></div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <div class="title"><span>Call Executed: Advance to Diligence</span><span class="count" id="not-passed-count">0 companies</span></div>
      <div class="grid" id="not-passed-grid"></div>
    </div>
  </div>

  <script>
    const CONFIG = {
      endpointBase: "https://script.google.com/macros/s/AKfycbyRF62OEmU2SFH3juvFeCmklF4nKLhFr-6VEGNFHES4ZCi5D0-1dOx7LK4fSs_fiDJN/exec",
      view: "marketmap"
    };

    const $ = (id) => document.getElementById(id);

    function setStatus(type, text) {
      const el = $("status");
      el.className = "status" + (type ? " " + type : "");
      el.textContent = text;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function pct(n, d) { return d ? ((n / d) * 100).toFixed(1) + "%" : "0.0%"; }

    function buildApiUrl(base, params) {
      const u = new URL(base);
      Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
      return u.toString();
    }

    function loadJsonp(url, callbackName) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url;
        script.async = true;
        const timer = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, 15000);

        function cleanup() {
          clearTimeout(timer);
          script.remove();
          try { delete window[callbackName]; } catch (e) {}
        }

        window[callbackName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("JSONP script failed")); };
        document.head.appendChild(script);
      });
    }

    function safeOpen(url) {
      if (!url) return;
      try { window.open(new URL(url, location.href).href, "_blank", "noopener,noreferrer"); } catch {}
    }

    function isTouchUi() {
      return window.matchMedia("(hover: none), (pointer: coarse)").matches;
    }

    function closeAllTooltips(exceptCard) {
      document.querySelectorAll(".card.show-tip").forEach((el) => {
        if (exceptCard && el === exceptCard) return;
        el.classList.remove("show-tip");
      });
    }

function positionTooltip(card, tip) {
  const pad = 12;
  const gap = 10;
  const cardRect = card.getBoundingClientRect();

  // Set max height first, then measure final tooltip size
  tip.style.maxHeight = `${Math.max(220, window.innerHeight - pad * 2)}px`;

  const tipRect = tip.getBoundingClientRect();

  // Prefer above; if not enough space, place below.
  let top = cardRect.top - tipRect.height - gap;
  if (top < pad) {
    top = cardRect.bottom + gap;
  }
  // Final clamp to viewport
  top = Math.max(pad, Math.min(top, window.innerHeight - tipRect.height - pad));

  // Center horizontally, then clamp
  let left = cardRect.left + (cardRect.width - tipRect.width) / 2;
  left = Math.max(pad, Math.min(left, window.innerWidth - tipRect.width - pad));

  tip.style.top = `${top}px`;
  tip.style.left = `${left}px`;
}

    function toPassed(row) {
      const raw = row["Passed"];
      if (typeof raw === "boolean") return raw;
      if (typeof raw === "number") return raw > 0;
      const v = String(raw || "").trim().toLowerCase();
      return ["1","true","yes","y","passed"].includes(v);
    }

    function normalizeHttpUrl(rawUrl) {
      const s = String(rawUrl || "").trim();
      if (!s) return "";
      const withScheme = /^[a-z]+:\/\//i.test(s) ? s : ("https://" + s);
      try {
        const u = new URL(withScheme);
        if (!/^https?:$/i.test(u.protocol)) return "";
        return u.toString();
      } catch (e) {
        return "";
      }
    }

    function deriveDomain(rawUrl) {
      const u = normalizeHttpUrl(rawUrl);
      if (!u) return "";
      try { return new URL(u).hostname.replace(/^www\./i, ""); } catch (e) { return ""; }
    }

    function logoCandidates(company) {
      const out = [];
      [company["Logo link merged"], company["Logo link"], company["logo"]].forEach((raw) => {
        const explicit = normalizeHttpUrl(raw || "");
        if (explicit) out.push(explicit);
      });

      const domain = deriveDomain(company["Url"] || "");
      if (domain) {
        out.push("https://logo.clearbit.com/" + domain);
        out.push("https://www.google.com/s2/favicons?sz=128&domain=" + encodeURIComponent(domain));
        out.push("https://icons.duckduckgo.com/ip3/" + encodeURIComponent(domain) + ".ico");
      }

      return [...new Set(out.filter(Boolean))];
    }

    function makeCard(company, passed) {
      const name = String(company["Company Name"] || "Unknown").trim();
      const category = String(company["Category"] || "").trim();
      const display = category ? `${name} (${category})` : name;
      const url = String(company["Url"] || "").trim();
      const notes = String(company["Call Notes"] || "").trim();
      const decision = String(company["Decision And Reason"] || "").trim();

      const card = document.createElement("div");
      card.className = "card";
      card.addEventListener("click", (e) => {
        if (!isTouchUi()) {
          safeOpen(url);
          return;
        }
        if (card.classList.contains("show-tip")) {
          safeOpen(url);
          return;
        }
        e.preventDefault();
        e.stopPropagation();
        closeAllTooltips(card);
        card.classList.add("show-tip");
      });

      const wrap = document.createElement("div");
      wrap.className = "logoWrap";
      const img = document.createElement("img");
      img.className = "logo";
      img.alt = display;
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      const ph = document.createElement("div");
      ph.className = "placeholder";
      ph.textContent = display;

      const cands = logoCandidates(company);
      let i = 0;
      function nextLogo() {
        if (i >= cands.length) return false;
        img.src = cands[i++];
        return true;
      }

      img.onload = () => { img.style.display = "block"; ph.style.display = "none"; };
      img.onerror = () => { if (!nextLogo()) { img.style.display = "none"; ph.style.display = "block"; } };
      const hasInitialLogo = nextLogo();
      img.style.display = hasInitialLogo ? "block" : "none";
      ph.style.display = hasInitialLogo ? "none" : "block";

      const nameEl = document.createElement("div");
      nameEl.className = "name";
      nameEl.textContent = display;

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = passed ? "Pass" : "Advance";

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
      const noteText = notes || "No call notes available.";
      const decisionText = decision || "No decision notes available.";
      tooltip.innerHTML =
        "<strong>Call Notes</strong>" +
        escapeHtml(noteText).replaceAll("\n", "<br>") +
        "<br><br><strong>Decision And Reason</strong><br>" +
        escapeHtml(decisionText).replaceAll("\n", "<br>");
      tooltip.addEventListener("click", (e) => e.stopPropagation());

      card.addEventListener("mouseenter", () => {
        if (!isTouchUi()) positionTooltip(card, tooltip);
      });

      wrap.appendChild(img);
      wrap.appendChild(ph);
      card.appendChild(wrap);
      card.appendChild(nameEl);
      card.appendChild(tag);
      card.appendChild(tooltip);
      return card;
    }

    async function loadAndRender() {
      setStatus("", "Loading data…");

      const cb = "cb_" + Math.random().toString(16).slice(2);
      const url = buildApiUrl(CONFIG.endpointBase, {
        view: CONFIG.view,
        callback: cb,
        t: String(Date.now())
      });

      let payload;
      try {
        payload = await loadJsonp(url, cb);
      } catch (e) {
        setStatus("error", "Failed to load data: " + e.message);
        return;
      }

      if (!payload || payload.ok !== true) {
        setStatus("error", "Endpoint error: " + (payload && payload.error ? payload.error : "Unknown"));
        return;
      }

      const contacted = Number(payload?.funnel?.contacted || 0);
      const connected = Number(payload?.funnel?.connected || 0);
      const callExecuted = Number(payload?.funnel?.callExecuted || 0);

      $("count-contacted").textContent = String(contacted);
      $("count-connected").textContent = String(connected);
      $("count-call-executed").textContent = String(callExecuted);
      $("metric-connection-rate").textContent = pct(connected, contacted);
      $("metric-call-executed-rate").textContent = pct(callExecuted, contacted);

      const rows = Array.isArray(payload.callExecutedCompanies) ? payload.callExecutedCompanies : [];
      const passed = rows.filter(toPassed);
      const notPassed = rows.filter(r => !toPassed(r));

      $("passed-count").textContent = passed.length + " companies";
      $("not-passed-count").textContent = notPassed.length + " companies";

      const passedGrid = $("passed-grid");
      const npGrid = $("not-passed-grid");
      passedGrid.innerHTML = "";
      npGrid.innerHTML = "";

      passed.forEach(c => passedGrid.appendChild(makeCard(c, true)));
      notPassed.forEach(c => npGrid.appendChild(makeCard(c, false)));

      if (!passed.length) passedGrid.innerHTML = '<div class="status">No passed companies in call executed.</div>';
      if (!notPassed.length) npGrid.innerHTML = '<div class="status">No advanced companies in call executed.</div>';

      setStatus("ok", "Loaded successfully.");
    }

    document.addEventListener("click", () => closeAllTooltips());

    loadAndRender();
  </script>
</body>
</html>
