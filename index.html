<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shane Wilson for Ibex: Winter 2026 Market Map</title>
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #fff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #7c3aed;
      --brand-soft: #ede9fe;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      background: radial-gradient(1000px 450px at top, #f3f0ff 0%, var(--bg) 45%, #f8fafc 100%);
      padding: 24px 14px 32px;
      color: var(--ink);
    }

    .container { max-width: 1500px; margin: 0 auto; }

    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--line);
    }

    .header h1 {
      font-size: clamp(1.7rem, 4.2vw, 2.8rem);
      font-weight: 800;
      color: #5b35ba;
      margin-bottom: 8px;
      line-height: 1.15;
      letter-spacing: -0.02em;
    }

    .header .subtitle {
      font-size: clamp(0.95rem, 2vw, 1.1rem);
      color: var(--muted);
    }

    .nav-links {
      text-align: center;
      margin: 14px 0 16px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-links a {
      display: inline-block;
      padding: 9px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
      text-decoration: none;
      color: #5d2cc5;
      border: 1px solid #ddd6fe;
      background: var(--brand-soft);
      transition: all .2s ease;
    }

    .nav-links a:hover, .nav-links a.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .status {
      max-width: 1100px;
      margin: 0 auto 16px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: #374151;
      font-size: 14px;
      line-height: 1.35;
    }
    .status strong { color: #111827; }
    .status.error { border-color: #fecaca; background: #fff1f2; color: #991b1b; }
    .status.ok { border-color: #bbf7d0; background: #ecfdf5; color: #065f46; }
    .status .muted { color: #6b7280; }

    .controls {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 12px;
      margin: 10px auto 20px auto;
      max-width: 1400px;
      align-items: start;
    }

    .search input {
      width: 100%;
      padding: 11px 13px;
      border-radius: 12px;
      border: 1px solid var(--line);
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    .pillbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .pill {
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid #ddd6fe;
      background: #f5f3ff;
      color: #5d2cc5;
      font-size: 12px;
      text-decoration: none;
      font-weight: 600;
    }

    .pill.active { background: var(--brand); color: #fff; border-color: var(--brand); }

    .section { margin: 24px auto 16px auto; max-width: 1600px; }

    .section-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      padding: 0 2px;
      align-items: baseline;
    }

    .section-title { font-size: clamp(1rem, 2.1vw, 1.3rem); font-weight: 800; }
    .section-count { font-size: 12px; color: var(--muted); font-weight: 700; }

    .grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
    }

    .card {
      position: relative;
      background: var(--surface);
      border: 1px solid #e9d5ff;
      border-radius: 14px;
      padding: 14px 10px 12px;
      min-height: 126px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      transition: all .2s ease;
    }

    .card:hover { border-color: #a78bfa; box-shadow: 0 8px 24px rgba(124,58,237,.12); }

    .logo-shell {
      width: 78px;
      height: 60px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #eef0f4;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: contrast(1.08) saturate(1.05);
    }

    .placeholder {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(135deg, #ede9fe 0%, #faf5ff 100%);
      color: #6d28d9;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      padding: 6px;
      line-height: 1.2;
    }

    .name {
      font-size: 13px;
      font-weight: 700;
      color: #374151;
      line-height: 1.25;
      word-break: break-word;
    }

    .tooltip {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 10px);
      transform: translateX(-50%);
      width: min(90vw, 340px);
      background: rgba(17,24,39,.96);
      color: #fff;
      padding: 12px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.35;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 20;
      text-align: left;
    }

    .card:hover .tooltip { opacity: 1; transform: translateX(-50%) translateY(-2px); }

    .tooltip h4 { font-size: 13px; margin-bottom: 6px; font-weight: 800; }
    .tooltip .content { max-height: 180px; overflow: auto; }

    .footer {
      text-align: center;
      margin-top: 42px;
      padding-top: 24px;
      border-top: 1px solid var(--line);
    }

    .footer-branding { font-size: 13px; color: #9ca3af; }

    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (max-width: 900px) {
      .controls { grid-template-columns: 1fr; }
      .pillbar { justify-content: flex-start; }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px) {
      body { padding: 14px 10px 24px; }
      .grid { grid-template-columns: 1fr; gap: 10px; }
      .card { min-height: 106px; }
    }
    @media (hover: none) { .tooltip { display: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="page-title">Shane Wilson for Ibex: Winter 2026 Market Map</h1>
      <div class="subtitle" id="page-subtitle">Landscape of relevant companies, grouped by category</div>
      <div class="nav-links">
        <a class="active" href="index.html">Market Map</a>
        <a href="sales_funnel.html">Deal Flow</a>
      </div>
    </div>

    <div id="status" class="status">
      <strong>Loading data</strong>
      <div class="muted">If this hangs, the endpoint URL is wrong or blocked.</div>
    </div>

    <div class="controls">
      <div class="search"><input id="search" type="text" placeholder="Search companies (name, about, category)" /></div>
      <div class="pillbar" id="pillbar"></div>
    </div>

    <div id="sections"></div>

    <div class="footer">
      <div class="footer-branding" id="footer-text">© 2026 IBEX Investors, Inc. | Winter 2026</div>
    </div>
  </div>

  <script>
    const CONFIG = {
      endpointBase:"https://script.google.com/macros/s/AKfycbyRF62OEmU2SFH3juvFeCmklF4nKLhFr-6VEGNFHES4ZCi5D0-1dOx7LK4fSs_fiDJN/exec",
      view: "marketmap",
      pageTitle: "Shane Wilson for Ibex: Winter 2026 Market Map",
      pageSubtitle: "Landscape of relevant companies, grouped by category",
      footerText: "© 2026 IBEX Investors, Inc. | Winter 2026"
    };

    function $(id) { return document.getElementById(id); }
    function escapeHtml(str) {
      return String(str ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }
    function setStatus(type, title, details) {
      const el = $("status");
      el.className = "status " + (type || "");
      el.innerHTML = `<strong>${escapeHtml(title)}</strong>${details ? `<div class="muted">${escapeHtml(details)}</div>` : ""}`;
    }
    function safeOpen(url) {
      if (!url) return;
      try { window.open(new URL(url, window.location.href).href, "_blank", "noopener,noreferrer"); } catch {}
    }
    function slugify(s) {
      return String(s || "").toLowerCase().trim().replace(/&/g, "and").replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
    }
    function loadJsonp(url, callbackName) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url; script.async = true;
        const timeout = setTimeout(() => { cleanup(); reject(new Error("JSONP request timed out")); }, 15000);
        function cleanup() { clearTimeout(timeout); script.remove(); try { delete window[callbackName]; } catch { window[callbackName] = undefined; } }
        window[callbackName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("Failed to load JSONP script")); };
        document.head.appendChild(script);
      });

   function deriveDomain(rawUrl) {
  const s = String(rawUrl || "").trim();
  if (!s) return "";
  const withScheme = /^[a-z]+:\/\//i.test(s) ? s : ("https://" + s);
  try { return new URL(withScheme).hostname.replace(/^www\./i, ""); } catch { return ""; }
}

function createLogoFallback(img, logoUrl, companyUrl) {
  const candidates = [];
  if (logoUrl) candidates.push(logoUrl);
  const domain = deriveDomain(companyUrl);
  if (domain) {
    candidates.push("https://logo.clearbit.com/" + domain);
    candidates.push("https://www.google.com/s2/favicons?sz=128&domain=" + encodeURIComponent(domain));
    candidates.push("https://icons.duckduckgo.com/ip3/" + encodeURIComponent(domain) + ".ico");
  }
  let i = 0;
  return () => (i < candidates.length ? (img.src = candidates[i++], true) : false);


      const card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", name);
      card.addEventListener("click", () => safeOpen(url));
      card.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); safeOpen(url); } });

      const logoShell = document.createElement("div");
      logoShell.className = "logo-shell";

      const img = document.createElement("img");
      img.className = "logo";
      img.alt = name;
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.style.display = "none";

      const placeholder = document.createElement("div");
      placeholder.className = "placeholder";
      placeholder.style.display = "flex";
      placeholder.textContent = name;

      const tryNextLogo = createLogoFallback(img, logo, url);

      img.onload = () => {
        if (img.naturalWidth > 0) {
          img.style.display = "block";
          placeholder.style.display = "none";
        } else if (!tryNextLogo()) {
          img.style.display = "none";
          placeholder.style.display = "flex";
        }
      };
      img.onerror = () => {
        if (!tryNextLogo()) {
          img.style.display = "none";
          placeholder.style.display = "flex";
        }
      };
      if (!tryNextLogo()) placeholder.style.display = "flex";

      const title = document.createElement("div");
      title.className = "name";
      title.textContent = name;

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
      tooltip.innerHTML = `<h4>${escapeHtml(name)}</h4><div class="content">${escapeHtml(about || "No description available.").replaceAll("\n", "<br>")}</div>`;

      logoShell.appendChild(img);
      logoShell.appendChild(placeholder);
      card.appendChild(logoShell);
      card.appendChild(title);
      card.appendChild(tooltip);
      return card;
    }

    function render(payload) {
      const mm = payload.marketMapData || {};
      const categories = Object.keys(mm);

      const pillbar = $("pillbar");
      pillbar.innerHTML = "";
      pillbar.innerHTML += `<a class="pill active" href="#all">All</a>`;
      categories.forEach(cat => pillbar.innerHTML += `<a class="pill" href="#${slugify(cat)}">${escapeHtml(cat)}</a>`);

      const sections = $("sections");
      sections.innerHTML = "";
      categories.forEach(cat => {
        const items = Array.isArray(mm[cat]) ? mm[cat] : [];
        const section = document.createElement("div");
        section.className = "section";
        section.id = slugify(cat);
        section.innerHTML = `<div class="section-header"><div class="section-title">${escapeHtml(cat)}</div><div class="section-count">${items.length} companies</div></div>`;
        const grid = document.createElement("div");
        grid.className = "grid";
        items.forEach(c => grid.appendChild(makeCard(c)));
        section.appendChild(grid);
        sections.appendChild(section);
      });

      const search = $("search");
      search.addEventListener("input", () => {
        const q = search.value.trim().toLowerCase();
        sections.querySelectorAll(".section").forEach(sec => {
          const cards = sec.querySelectorAll(".card");
          let visible = 0;
          cards.forEach(card => {
            const name = (card.querySelector(".name")?.textContent || "").toLowerCase();
            const tip = (card.querySelector(".tooltip .content")?.textContent || "").toLowerCase();
            const cat = (sec.querySelector(".section-title")?.textContent || "").toLowerCase();
            const ok = !q || name.includes(q) || tip.includes(q) || cat.includes(q);
            card.style.display = ok ? "" : "none";
            if (ok) visible++;
          });
          sec.style.display = visible ? "" : "none";
          const countEl = sec.querySelector(".section-count");
          if (countEl) countEl.textContent = `${visible} companies`;
        });
      });

      function setActivePill() {
        const hash = (location.hash || "#all");
        pillbar.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
        (Array.from(pillbar.querySelectorAll(".pill")).find(p => p.getAttribute("href") === hash) || pillbar.querySelector(".pill"))?.classList.add("active");
      }
      window.addEventListener("hashchange", setActivePill);
      setActivePill();
    }

    async function load() {
      $("page-title").textContent = CONFIG.pageTitle;
      $("page-subtitle").textContent = CONFIG.pageSubtitle;
      $("footer-text").textContent = CONFIG.footerText;
      setStatus("", "Loading data", "Fetching from Apps Script (JSONP)");

      const cbName = "handleMarketMapPayload_" + Math.random().toString(16).slice(2);
      const u = new URL(CONFIG.endpointBase);
u.searchParams.set("view", CONFIG.view);
u.searchParams.set("callback", cbName);
u.searchParams.set("t", String(Date.now()));
const url = u.toString();
      
      let payload;
      try { payload = await loadJsonp(url, cbName); }
      catch (err) { setStatus("error", "Failed to load data", String(err)); return; }

      if (!payload || payload.ok !== true) {
        setStatus("error", "Endpoint returned an error", payload?.error || "Unknown error");
        return;
      }

      render(payload);
      setStatus("ok", "Loaded successfully", `Rows: ${payload?.meta?.rows ?? ""}. Timestamp: ${payload?.meta?.timestamp || ""}`);
    }
    load();
  </script>
</body>
</html>
