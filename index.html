<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shane Wilson for Ibex: Winter 2026 Market Map</title>
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #fff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #7c3aed;
      --brand-soft: #ede9fe;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, sans-serif;
      background: radial-gradient(1000px 450px at top, #f3f0ff 0%, var(--bg) 45%, #f8fafc 100%);
      color: var(--ink);
      padding: 20px 12px 28px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid var(--line); }
    h1 { font-size: clamp(1.6rem, 4vw, 2.6rem); color: #5b35ba; margin-bottom: 8px; }
    .subtitle { color: var(--muted); }
    .nav {
      display: flex; justify-content: center; gap: 10px; margin: 12px 0 16px; flex-wrap: wrap;
    }
    .nav a {
      text-decoration: none; padding: 8px 13px; border-radius: 999px;
      border: 1px solid #ddd6fe; background: #ede9fe; color: #5d2cc5; font-weight: 600;
    }
    .nav a.active { background: var(--brand); color: #fff; border-color: var(--brand); }

    .status {
      margin: 0 auto 14px; max-width: 900px; border: 1px solid var(--line);
      background: #fff; padding: 11px 13px; border-radius: 10px; font-size: 14px;
    }
    .status.error { border-color: #fecaca; background: #fff1f2; color: #991b1b; }
    .status.ok { border-color: #bbf7d0; background: #ecfdf5; color: #065f46; }

.controls {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 10px auto 18px;
  align-items: center;
  max-width: 1240px;
}
.search {
  width: 100%;
}
.search input {
  width: 100%;
 padding: 11px 13px; border-radius: 12px; border: 1px solid var(--line);
      font-size: 14px; outline: none; background: #fff;
    }
    .pillbar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; }
    .pill {
      display: inline-block; padding: 8px 12px; border-radius: 999px;
      border: 1px solid #ddd6fe; background: var(--brand-soft); color: #5d2cc5;
      font-size: 12px; font-weight: 700; text-decoration: none;
    }

    .section { margin-bottom: 16px; }
    .section-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .section-title { font-weight: 800; }
    .section-count { color: var(--muted); font-size: 12px; text-transform: uppercase; }

    .grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 10px; }
    .card {
      border: 1px solid #e9d5ff; background: #fff; border-radius: 12px; padding: 12px 10px;
      min-height: 122px; text-align: center; cursor: pointer; position: relative;
    }
    .logo-shell {
      width: 84px; height: 58px; margin: 0 auto 8px; border: 1px solid #eef0f4;
      border-radius: 9px; padding: 7px; display: flex; align-items: center; justify-content: center;
      background: #fff;
    }
    .logo { width: 100%; height: 100%; object-fit: contain; display: none; }
    .placeholder { font-size: 11px; color: #7c3aed; font-weight: 700; line-height: 1.2; }
    .name { font-size: 12.5px; font-weight: 700; color: #374151; line-height: 1.25; }

    .tooltip {
      position: absolute; left: 50%; bottom: calc(100% + 10px); transform: translateX(var(--tip-x, -50%));
      width: min(92vw, 420px); background: rgba(17,24,39,.96); color: #fff; padding: 12px;
      border-radius: 12px; font-size: 12px; line-height: 1.35; box-shadow: 0 10px 30px rgba(0,0,0,.25);
      opacity: 0; pointer-events: none; transition: opacity .15s ease, transform .15s ease; z-index: 20; text-align: left;
      max-height: 320px; overflow: auto;
    }
    .card.show-tip .tooltip { opacity: 1; pointer-events: auto; transform: translateX(var(--tip-x, -50%)) translateY(-2px); }
    @media (hover: hover) {
      .card:hover .tooltip { opacity: 1; transform: translateX(var(--tip-x, -50%)) translateY(-2px); }
    }


    @media (max-width:1100px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width:760px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width:520px) { .grid { grid-template-columns: 1fr; } }
    
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Shane Wilson for Ibex: Winter 2026 Market Map</h1>
      <div class="subtitle">Landscape of relevant companies, grouped by category</div>
      <div class="nav">
        <a class="active" href="index.html">Market Map</a>
        <a href="sales_funnel.html">Deal Flow</a>
      </div>
    </div>

    <div id="status" class="status">Loading data…</div>

    <div class="controls">
      <div class="search">
        <input id="search" type="text" placeholder="Search companies (name, about, category)" />
      </div>
      <div class="pillbar" id="pillbar"></div>
    </div>

    <div id="sections"></div>
  </div>

  <script>
    const CONFIG = {
      endpointBase: "https://script.google.com/macros/s/AKfycbyRF62OEmU2SFH3juvFeCmklF4nKLhFr-6VEGNFHES4ZCi5D0-1dOx7LK4fSs_fiDJN/exec",

    };

    const $ = (id) => document.getElementById(id);

    function setStatus(type, text) {
      const el = $("status");
      el.className = "status" + (type ? " " + type : "");
      el.textContent = text;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function buildApiUrl(base, params) {
      const u = new URL(base);
      Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
      return u.toString();
    }

    function loadJsonp(url, callbackName) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url;
        script.async = true;

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP request timed out"));
        }, 15000);

        function cleanup() {
          clearTimeout(timeout);
          script.remove();
          try { delete window[callbackName]; } catch (e) { window[callbackName] = undefined; }
        }

        window[callbackName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("Failed to load JSONP script")); };
        document.head.appendChild(script);
      });
    }

    function slugify(s) {
      return String(s || "")
        .toLowerCase()
        .trim()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

function safeOpen(url) {
  if (!url) return;
  try { window.open(new URL(url, location.href).href, "_blank", "noopener,noreferrer"); } catch (e) {}
}

function isTouchUi() {
  return window.matchMedia("(hover: none), (pointer: coarse)").matches;
}

function closeAllTooltips(exceptCard) {
  document.querySelectorAll(".card.show-tip").forEach((el) => {
    if (exceptCard && el === exceptCard) return;
    el.classList.remove("show-tip");
  });
}

function positionTooltip(card, tooltip) {
  const pad = 14;
  const vw = window.innerWidth || document.documentElement.clientWidth;
  const cardRect = card.getBoundingClientRect();

  // Use a stable width so clamp math matches rendering.
  const tipWidth = Math.min(420, Math.max(260, vw - (pad * 2)));
  tooltip.style.width = tipWidth + "px";

  const center = cardRect.left + (cardRect.width / 2);
  const minCenter = pad + (tipWidth / 2);
  const maxCenter = vw - pad - (tipWidth / 2);
  const clamped = Math.max(minCenter, Math.min(maxCenter, center));
  const dx = Math.round(clamped - center);

  tooltip.style.setProperty("--tip-x", `calc(-50% + ${dx}px)`);
}

    function deriveDomain(rawUrl) {
      const s = String(rawUrl || "").trim();
      if (!s) return "";
      const withScheme = /^[a-z]+:\/\//i.test(s) ? s : ("https://" + s);
      try { return new URL(withScheme).hostname.replace(/^www\./i, ""); } catch (e) { return ""; }
    }

    function normalizeHttpUrl(rawUrl) {
      const s = String(rawUrl || "").trim();
      if (!s) return "";
      const withScheme = /^[a-z]+:\/\//i.test(s) ? s : ("https://" + s);
      try {
        const u = new URL(withScheme);
        if (!/^https?:$/i.test(u.protocol)) return "";
        return u.toString();
      } catch (e) {
        return "";
      }
    }

    function isDirectImageUrl(rawUrl) {
      const u = normalizeHttpUrl(rawUrl);
      if (!u) return false;
      try {
        const parsed = new URL(u);
        const host = parsed.hostname.toLowerCase();
        const path = parsed.pathname.toLowerCase();
        if (
          host.includes("linkedin.com") ||
          host.includes("pitchbook.com") ||
          host.includes("crunchbase.com")
        ) {
          return false;
        }
        if (path.includes("/profile") || path.includes("/people") || path.includes("/person") || path.includes("/company")) return false;
        return true;
      } catch (e) {
        return false;
      }
    }

function createLogoFallback(img, logoUrls, companyUrl) {
  const candidates = [];

  (Array.isArray(logoUrls) ? logoUrls : [logoUrls]).forEach((logoUrl) => {
    const logoCandidate = normalizeHttpUrl(logoUrl);
    if (logoCandidate) candidates.push(logoCandidate);
  });

  const domain = deriveDomain(companyUrl);
  if (domain) {
    candidates.push("https://logo.clearbit.com/" + domain);
    candidates.push("https://www.google.com/s2/favicons?sz=128&domain=" + encodeURIComponent(domain));
    candidates.push("https://icons.duckduckgo.com/ip3/" + encodeURIComponent(domain) + ".ico");
  }

  const unique = [];
  const seen = new Set();
  candidates.forEach((c) => {
    if (!c || seen.has(c)) return;
    seen.add(c);
    unique.push(c);
  });

  let i = 0;
  return () => {
    if (i >= unique.length) return false;
    img.src = unique[i++];
    return true;
  };
}

function makeCard(company) {

      const name = String(company["Company Name"] || "").trim() || "Unknown";
      const url = String(company["Url"] || "").trim();
      const logoMerged = String(company["Logo link merged"] || "").trim();
      const logoLink = String(company["Logo link"] || "").trim();
      const logoRaw = String(company["logo"] || "").trim();
      const about = String(company["About"] || "").trim();

      const card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
card.addEventListener("click", (e) => {
  if (!isTouchUi()) {
    safeOpen(url);
    return;
  }
  if (card.classList.contains("show-tip")) {
    safeOpen(url);
    return;
  }
  e.preventDefault();
  e.stopPropagation();
  closeAllTooltips(card);
  card.classList.add("show-tip");
});
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          safeOpen(url);
        }
      });

      const logoShell = document.createElement("div");
      logoShell.className = "logo-shell";

      const img = document.createElement("img");
      img.className = "logo";
      img.alt = name;
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";

      const placeholder = document.createElement("div");
      placeholder.className = "placeholder";
      placeholder.textContent = name;

const tryNextLogo = createLogoFallback(img, [logoMerged, logoLink, logoRaw], url);

img.onload = () => {
  img.style.display = "block";
  placeholder.style.display = "none";
};

img.onerror = () => {
  if (!tryNextLogo()) {
    img.style.display = "none";
    placeholder.style.display = "block";
  }
};

const hasInitialLogo = tryNextLogo();
img.style.display = hasInitialLogo ? "block" : "none";
placeholder.style.display = hasInitialLogo ? "none" : "block";


      const title = document.createElement("div");
      title.className = "name";
      title.textContent = name;

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
tooltip.innerHTML = "<strong>" + escapeHtml(name) + "</strong><br><br>" +
  escapeHtml(about || "No description available.").replaceAll("\n", "<br>");
tooltip.addEventListener("click", (e) => e.stopPropagation());
      card.addEventListener("mouseenter", () => {
        if (!isTouchUi()) positionTooltip(card, tooltip);
      });

      logoShell.appendChild(img);
      logoShell.appendChild(placeholder);
      card.appendChild(logoShell);
      card.appendChild(title);
      card.appendChild(tooltip);

      return card;
    }

    function render(payload) {
      const data = payload.marketMapData || {};
      const categories = Object.keys(data);

      const pillbar = $("pillbar");
      pillbar.innerHTML = "";
      pillbar.innerHTML += '<a class="pill" href="#all">All</a>';
      categories.forEach(cat => {
        pillbar.innerHTML += '<a class="pill" href="#' + slugify(cat) + '">' + escapeHtml(cat) + "</a>";
      });

      const sections = $("sections");
      sections.innerHTML = "";

      categories.forEach(cat => {
        const items = Array.isArray(data[cat]) ? data[cat] : [];

        const section = document.createElement("div");
        section.className = "section";
        section.id = slugify(cat);

        section.innerHTML =
          '<div class="section-header">' +
            '<div class="section-title">' + escapeHtml(cat) + "</div>" +
            '<div class="section-count">' + items.length + " companies</div>" +
          "</div>";

        const grid = document.createElement("div");
        grid.className = "grid";

        items.forEach(company => grid.appendChild(makeCard(company)));

        section.appendChild(grid);
        sections.appendChild(section);
      });

      const search = $("search");
      search.addEventListener("input", () => {
        const q = search.value.trim().toLowerCase();
        const cards = sections.querySelectorAll(".card");
        cards.forEach(card => {
          const t = card.textContent.toLowerCase();
          card.style.display = !q || t.includes(q) ? "" : "none";
        });
      });
    }

    async function loadAndRender() {
      setStatus("", "Loading data…");

      const cb = "cb_" + Math.random().toString(16).slice(2);
      const url = buildApiUrl(CONFIG.endpointBase, {
        view: "marketmap",
        callback: cb,
        t: String(Date.now())
      });

      let payload;
      try {
        payload = await loadJsonp(url, cb);
      } catch (e) {
        setStatus("error", "Failed to load data: " + e.message);
        return;
      }

      if (!payload || payload.ok !== true) {
        setStatus("error", "Endpoint error: " + (payload && payload.error ? payload.error : "Unknown"));
        return;
      }

      render(payload);
      setStatus("ok", "Loaded successfully.");
    }

    document.addEventListener("click", () => closeAllTooltips());

    loadAndRender();
  </script>
</body>
</html>
